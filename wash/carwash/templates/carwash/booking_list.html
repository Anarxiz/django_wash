{% extends 'carwash/base.html' %}

{% block title %}Записи - Автомойка{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-8">
        <h1>Записи клиентов</h1>
    </div>
    <div class="col-md-4 text-end">
        <a href="{% url 'booking_create' %}" class="btn btn-primary">Новая запись</a>
    </div>
</div>

<div class="row mb-3">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <form method="get" class="row g-3">
                    <div class="col-md-4">
                        <input type="text" name="search" class="form-control" placeholder="Поиск по имени или телефону" value="{{ request.GET.search }}">
                    </div>
                    <div class="col-md-3">
                        <select name="status" class="form-control">
                            <option value="">Все статусы</option>
                            {% for value, label in status_choices %}
                            <option value="{{ value }}" {% if request.GET.status == value %}selected{% endif %}>{{ label }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-3">
                        <button type="submit" class="btn btn-secondary">Фильтровать</button>
                        <a href="{% url 'booking_list' %}" class="btn btn-outline-secondary">Сбросить</a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>Дата/Время</th>
                                <th>Клиент</th>
                                <th>Телефон</th>
                                <th>Услуги</th>
                                <th>Бокс</th>
                                <th>Мойщик</th>
                                <th>Статус</th>
                                <th>Цена</th>
                                <th>Действия</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for booking in bookings %}
                            <tr>
                                <td>{{ booking.scheduled_time|date:"d.m.Y H:i" }}</td>
                                <td>{{ booking.client.name }}</td>
                                <td>{{ booking.client.phone }}</td>
                                <td>
                                    {% for service in booking.services.all %}
                                    {{ service.name }}{% if not forloop.last %}, {% endif %}
                                    {% endfor %}
                                </td>
                                <td>{{ booking.box }}</td>
                                <td>{{ booking.washer|default:"Не назначен" }}</td>
                                <td>
                                    <span class="status-badge status-{{ booking.status }}">
                                        {{ booking.get_status_display }}
                                    </span>
                                    {% if booking.status == 'pending' or booking.status == 'in_progress' %}
                                    <div class="mt-1">
                                        <form method="post" action="{% url 'booking_update_status' booking.pk %}" style="display: inline;">
                                            {% csrf_token %}
                                            {% if booking.status == 'pending' %}
                                            <button type="submit" name="status" value="in_progress" class="btn btn-sm btn-success" onclick="return confirm('Перевести в работу?')">В работу</button>
                                            <button type="submit" name="status" value="completed" class="btn btn-sm btn-primary" onclick="return confirm('Завершить заявку?')">Завершить</button>
                                            {% elif booking.status == 'in_progress' %}
                                            <button type="submit" name="status" value="completed" class="btn btn-sm btn-primary" onclick="return confirm('Завершить заявку?')">Завершить</button>
                                            {% endif %}
                                        </form>
                                    </div>
                                    {% endif %}
                                </td>
                                <td>{{ booking.final_price }} ₽</td>
                                <td>
                                    <a href="{% url 'booking_detail' booking.pk %}" class="btn btn-sm btn-info">Подробнее</a>
                                    <a href="{% url 'booking_edit' booking.pk %}" class="btn btn-sm btn-primary">Редактировать</a>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="10" class="text-center">Записи не найдены</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

